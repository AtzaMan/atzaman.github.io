<!doctype html>
<!-- The DOCTYPE declaration above will set the     -->
<!-- browser's rendering engine into                -->
<!-- "Standards Mode". Replacing this declaration   -->
<!-- with a "Quirks Mode" doctype is not supported. -->
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Aleksandar Dordevic, ad185297" />
    <!--                                                               -->
    <!-- Consider inlining CSS to reduce the number of requested files -->
    <!--                                                               -->
    <link type="text/css" rel="stylesheet" href="JsQRScanner.css">
    <!--                                           -->
    <!-- Any title is fine                         -->
    <!--                                           -->
    <title>NCR Atleos QR Code Voucher Scanner</title>
    <!--                                           -->
    <!-- This script loads your compiled module.   -->
    <script type="text/javascript" src="jsqrscanner.nocache.js"></script>
    <!-- <script type="text/javascript" src="mqttws31.min.js"></script> -->
    <script src="mqtt.min.js"></script>
    <script src="script.js"></script>
  </head>
  <body>
    <div class="row-element-set row-element-set-QRScanner">
    <!-- RECOMMENDED if your web app will not function without JavaScript enabled -->
    <noscript>
      <div class="row-element-set error_message">
        Your web browser must have JavaScript enabled
        in order for this application to display correctly.
      </div>
    </noscript>
      <h1>NCR Atleos QR Code Voucher Scanner</h1>
      <div class="row-element">
        <div class="FlexPanel detailsPanel QRScannerShort">
          <div class="FlexPanel shortInfoPanel">
            <div class="gwt-HTML">
              Point the camera to a QR code.
            </div>
          </div>
        </div>
      </div>
      <br>
      <button id="publishStatus" onclick="changeSendStatus(this)">stop publishing</button>
      <div id="local"></div>
      <div id="remote"></div>
      <div class="row-element">
        <div class="qrscanner" id="scanner">
        </div>
      </div>
      <div class="row-element">
        <div class="form-field form-field-memo">
          <div class="form-field-caption-panel">
            <div class="gwt-Label form-field-caption">
              Scanned text:
            </div>
          </div>
          <div class="FlexPanel form-field-input-panel">
            <textarea id="scannedTextMemo" class="textInput form-memo form-field-input textInput-readonly" rows="3" readonly>
            </textarea>
          </div>
        </div>
        <div class="form-field form-field-memo">
          <div class="form-field-caption-panel">
            <div class="gwt-Label form-field-caption">
              Voucher Validation:
            </div>
          </div>
          <div class="FlexPanel form-field-input-panel">
            <textarea id="QRCodeVoucherResponse" class="textInput form-memo form-field-input textInput-readonly" value="" rows="6" readonly>
            </textarea>
          </div>
        </div>
      </div>
      <br>
    </div>
  <script type="text/javascript">
    /*
    var client = new Paho.MQTT.Client('mqtt.flespi.io', 80, '/mqtt', 'ncratleos_scanner');
    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;
    client.username = 'OK6tJ2nhulcncMpbtOBfhKxvZdQhbC4J2nynXA2bfhMD5tCf9tDSJC6QQPAV5kzH';
    client.password = '';
    client.connect({onSuccess:onConnect});
    
    function onConnect() {
      // Once a connection has been made, make a subscription and send a message.
      console.log("Connecting to MQTT broker...");
      client.subscribe("qlid_response");
      client.subscribe("ncratleos");
      message = new Paho.MQTT.Message("QR Code Scanner connected to MQTT broker");
      message.destinationName = "ncratleos";
      client.send(message);
    }

    function onConnectionLost(responseObject) {
      if (responseObject.errorCode !== 0) {
        console.log("onConnectionLost:"+responseObject.errorMessage);
      }
    }

    function onMessageArrived(message) {
      console.log("onMessageArrived:"+message.payloadString);
    }
    */
    function onQRCodeScanned(scannedText)
    {
    	var scannedTextMemo = document.getElementById("scannedTextMemo");
    	if(scannedTextMemo)
    	{
    		scannedTextMemo.value = scannedText;
    	}
      if(scannedText != ''){

      }

    	var QRCodeVoucherResponse = document.getElementById("QRCodeVoucherResponse");
    	if(QRCodeVoucherResponse)
    	{
    		QRCodeVoucherResponse.value = QRCodeVoucherResponse.value + '\n' + scannedText;
    	}
    }
    
    function provideVideo()
    {
        var n = navigator;

        if (n.mediaDevices && n.mediaDevices.getUserMedia)
        {
          return n.mediaDevices.getUserMedia({
            video: {
              facingMode: "environment"
            },
            audio: false
          });
        } 
        
        return Promise.reject('Your browser does not support getUserMedia');
    }

    function provideVideoQQ()
    {
        return navigator.mediaDevices.enumerateDevices()
        .then(function(devices) {
            var exCameras = [];
            devices.forEach(function(device) {
            if (device.kind === 'videoinput') {
              exCameras.push(device.deviceId)
            }
         });
            
            return Promise.resolve(exCameras);
        }).then(function(ids){
            if(ids.length === 0)
            {
              return Promise.reject('Could not find a webcam');
            }
            
            return navigator.mediaDevices.getUserMedia({
                video: {
                  'optional': [{
                    'sourceId': ids.length === 1 ? ids[0] : ids[1]//this way QQ browser opens the rear camera
                    }]
                }
            });        
        });                
    }
    
    //this function will be called when JsQRScanner is ready to use
    function JsQRScannerReady()
    {
        //create a new scanner passing to it a callback function that will be invoked when
        //the scanner succesfully scan a QR code
        var jbScanner = new JsQRScanner(onQRCodeScanned);
        //var jbScanner = new JsQRScanner(onQRCodeScanned, provideVideo);
        //reduce the size of analyzed image to increase performance on mobile devices
        jbScanner.setSnapImageMaxSize(300);
    	var scannerParentElement = document.getElementById("scanner");
    	if(scannerParentElement)
    	{
    	    //append the jbScanner to an existing DOM element
    		jbScanner.appendTo(scannerParentElement);
    	}        
    }
  </script>    
  </body>
</html>
